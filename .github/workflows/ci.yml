name: Labki Runtime CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Check file structure
        run: |
          if [ ! -f config/secrets.env.example ]; then echo "Missing secrets example"; exit 1; fi
          if [ ! -f config/LocalSettings.user.php.example ]; then echo "Missing config example"; exit 1; fi
          if [ ! -f docker-compose.yml ]; then echo "Missing docker-compose.yml"; exit 1; fi

      - name: Configure Secrets
        run: cp config/secrets.env.example config/secrets.env

      - name: Validate Docker Compose
        run: docker compose config

  smoke-test:
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Configure Secrets
        run: cp config/secrets.env.example config/secrets.env

      - name: Start Labki
        run: |
          chmod +x update.sh
          ./update.sh

      - name: Wait for Wiki to be ready
        run: |
          echo "Waiting for wiki to respond..."
          timeout=120
          counter=0
          while [ $counter -lt $timeout ]; do
            status=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080/wiki/Main_Page || echo "000")
            if [ "$status" == "200" ]; then
              echo "Wiki is UP!"
              exit 0
            fi
            sleep 5
            counter=$((counter + 1))
            echo "Waiting... ($counter/$timeout) - Status: $status"
          done
          echo "Timed out waiting for wiki"
          exit 1

      - name: Dump logs on failure
        if: failure()
        run: docker compose logs wiki
